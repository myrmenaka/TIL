# 2025.7.6 - セッションを使った簡易ショッピングカート

## 目的

セッションを活用して、`商品を追加` ・ `削除` ・ `一覧表示` するショッピングカート機能を実装できるようになる  

※セッションについて、使用関数などは、`Day15` に記述  

## 目次

- [セッションを使ってカート情報を保持](#1)
- [商品の追加処理](#2)
- [カート一覧の表示](#3)
- [カートない商品の削除](#4)

## 学習内容

<a id="1"></a>

### セッションを使ってカート情報を保持

- ユーザーごとに異なるカート内容を保持できる
- `$_SESSION['cart']` に商品情報（商品IDや数量）を保存

---
<a id="2"></a>

### 商品の追加処理

- フォームから商品IDや名前・数量を受け取り、セッションに追加
- 同じ商品を複数回追加した場合は数量を加算する

---
<a id="3"></a>

### カート一覧の表示

- セッションの中身（配列）をループで表示
- 合計金額などを計算表示することも可能

---
<a id="4"></a>

### カートない商品の削除

- 商品ごとに削除ボタンを設置し  
    ```php
    `unset($_SESSION['cart'][ID])` 
    ```
    で削除可能

---
---
## セキュリティ面での注意

- 出力時にはすべて `htmlspecalchars()` を使ってXSS対策を行う
- 商品IDや価格は、`サーバー側` で検証・固定するのが理想（フォーム書き換え防止）
- `$_GET['id']` を受け取るときは必ず `存在確認` を行い、`未定義アクセス` に注意
- `セッション固定攻撃` や `乗っ取り` に備えて、ログイン機能と組み合わせる場合は `session_regenerate_id()` を使用

## 練習問題 

以下の3つのファイルを作成し、ショッピングカート機能を実装  

- shop.php  
    商品一覧と「カートに追加」ボタン
- cart.php  
    カートの中身を表示
- delete.php  
    カートから商品を削除


## 作業チェックリスト

- セッションでカート情報を保持できたか
- 商品を複数追加しても数量が加算されるか
- カートの中身を正しく表示できたか
- 削除リンクで商品を削除できたか


## MEMO

- ショッピングカートの実装に、セッションとデータベースのどちらを使うかは、カートの機能や要件によって異なる  

    <セッション>  
    利点:  
    - 実装が比較的簡単で、高速に動作  
    - ユーザーのブラウザに紐づいた一時的な情報を保存するのに適している  
    - 例えば、現在カートに入っている商品や、ログイン状態などを保存するのに便利  

    欠点:  
    - サーバーのセッションストレージに依存するため、サーバーの負荷が高くなる可能性がある  
    - セッションデータは一定時間で消去されるため、長期的な保存には向かない  
    - ブラウザを閉じたり、セッションがタイムアウトするとデータは失われる  

    <データベース>  
    利点:  
    - 永続的なデータを保存でき、ユーザーがブラウザを閉じてもデータが失われることはない  
    - 大量のデータを扱うのに適している  
    - 複雑な検索や集計処理を行うことができる  

    欠点:  
    - セッションに比べて実装が複雑で、パフォーマンスも若干劣る場合がある  
    - データベースへのアクセスには時間がかかるため、頻繁にアクセスする場合はパフォーマンスに影響が出る可能性がある  

    <どちらを選ぶか？>  

    シンプルなカート:  
    - カートに商品を追加したり、削除したりする程度のシンプルな機能であれば、セッションで十分  

    複雑なカート:  
    - 商品の数量変更や、商品の詳細情報の表示、複数の商品をまとめて購入する機能など、複雑な機能が必要な場合は、データベースを使用する必要がある  

    ログインユーザー:  
    - ログインユーザーのカート情報を永続的に保存する必要がある場合は、データベースを使用する必要がある  

    ゲストユーザー:  
    - ゲストユーザーのカート情報を保存する場合は、セッションとデータベースの両方を使用する方法もある  
    - 例えば、セッションでカート情報を一時的に保存し、ユーザーがログインした際にデータベースに保存する方法  

- `タイポ` とは  
    → typo（typographical error）  
    「キーボードの打ち間違い」や「入力ミス」のことを指す  

- 隠しフィールド（hidden）で送る理由  
    → ユーザーに見せなくていいけど、サーバーに送りたい情報  

    例）  
    - 商品ID（id）  
    サーバー側でどの商品かを識別するために絶対必要  
    でもユーザーには見せる必要はない
    - 商品名（name）や価格（price）  
    すでに画面で表示してることが多いし、改めて編集してもらう必要がない  

- `cart.php` 解説  

    // POSTで追加された商品をセッションに保存  
    1．セッションで商品の保存処理  
    ```php
    if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    ```
    - 「フォームがPOSTで送信されたときだけ」中身を処理  
    [参考: PHPマニュアル : $_SERVER](https://www.php.net/manual/ja/reserved.variables.server.php)  

    ```php
    $id = $_POST['id'];
    $name = $_POST['name'];
    $price = (int)$_POST['price'];
    $quantity = (int)$_POST['quantity'];
    ```
    - ユーザーが送った商品データ（ID、名前、価格、数量）を受け取る
    - `price` と `quantity` は `int` にキャストしてるから、ちゃんと数値化されていて安心  

    2．カートに商品を追加  
    ```php
    if (!isset($_SESSION['cart'][$id])) {
    ```
    - セッション（$_SESSION）の中に、まだその商品IDがなければ…
    ```php
    $_SESSION['cart'][$id] = [
        'name' => $name,
        'price' => $price,
        'quantity' => $quantity
    ];
    ```
    - 新しくカートに商品を追加  
        配列の中に商品データを保存  
    ```php
    } else {
        $_SESSION['cart'][$id]['quantity'] += $quantity;
    }
    ```
    - すでに同じ商品がカートにあるなら、数量だけを足し増し（重複防止）  

    3．カートの中身を表示   
    ```php
    <h2>カートの中身</h2>
    <?php if (!empty($_SESSION['cart'])): ?>
    ```
    - カートが空じゃなかったら、以下の `<ul>` で商品一覧を表示  
    ```php
    <?php foreach ($_SESSION['cart'] as $id => $item): ?>
    ```
    - カートに入ってるすべての商品を1件ずつ取り出してループ  
    ```php
    <?php echo htmlspecialchars($item['name'], ENT_QUOTES, 'UTF-8'); ?>
    ```
    - 商品名を「XSS対策」付きで安全に表示  
    ```php
    ￥<?php echo $item['price']; ?> × <?php echo $item['quantity']; ?> =
    ￥<?php echo $item['price'] * $item['quantity']; ?>
    ```
    - 商品の「価格 × 数量 = 合計金額」を表示  
    ```php
    <a href="./delete.php?id=<?php echo $id; ?>">削除</a>
    ```
    - 商品を削除するためのリンク  
        対象商品IDをクエリ文字列で渡してる

    4．カートが空だった場合  
    ```php
    <?php else: ?>
        <p>カートは空です。</p>
    <?php endif; ?>
    ```
    - カートに商品が何もなければ、空っぽのメッセージを表示  

    5．商品一覧ページへ戻るリンク  
    ```php
    <p><a href="./shop.php">商品一覧に戻る</a></p>
    ```
    - 商品を選ぶページ（shop.php）に戻るためのリンク  

- `delete.php` 解説  
    ```php
    $id = $_GET['id'] ?? '';
    ```
    - `$_GET['id']` は URL から渡された id の値（例：delete.php?id=1）
    - `?? ''` は「もし id がなかったら空文字にする」という保険（PHP7以降の「null合体演算子」）  
    [参考: PHPマニュアル : 新機能 より null合体演算子](https://www.php.net/manual/ja/migration70.new-features.php)  
    - エラー防止と安全な初期化のテクニック
    ```php
    if (isset($_SESSION['cart'][$id])) {
    ```
    - セッション内のカートに、指定されたIDの商品が「存在しているか？」をチェック
    - 存在していれば、中の処理が実行される
    ```php
    unset($_SESSION['cart'][$id]);
    ```
    - `unset()` は指定した変数や配列の要素を削除する関数
    - この1行で、指定された商品をカート（セッション）から完全に削除
    ```php
    header('Location: cart.php');
    ```
    - ユーザーを `cart.php` にリダイレクト（画面遷移）する
    - これがないと「削除されたまま白い画面」で止まっちゃうので、ユーザー体験的にも大事な一行
    ```php
    exit;
    ```
    - リダイレクト後にこれ以上コードが実行されないように処理を終了
    - 忘れがちだけど、セキュリティやバグ防止のために大切

---

参考: []()
