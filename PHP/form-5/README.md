# 2025.7.2 - 基本文法 8-5 フォーム入力のセッション管理

## 目的

フォームで送信した入力値をセッションに保存し、ページをまたいでも保持・再表示できるようになる

## 目次

- [`セッション（session）` とは](#1)
- [セッションの開始方法](#2)
- [セッション変数の利用方法](#3)
- [フォーム入力値のセッション保存と再表示](#4)

## MEMO

<a id="1"></a>

### `セッション（session）` とは

- ユーザーごとの一時的な保存領域（サーバー側）
- ブラウザを閉じると基本的に消える（ただし設定次第で保持も可能）

>セッション : 論理的な意味での開始から終了まで（を意図する単位）  
[参考: 「分かりそう」で「分からない」でも「分かった」気になれるIT用語辞典 : セッション](https://wa3.i-3-i.info/word1791.html)  


---
<a id="2"></a>

### セッションの開始方法

以下を `スクリプトの一番上に記述` する  
```php
session_start();
```
→ `セッションID` が発行され、PHP内部で変数が使えるようになる  

[参考: 「分かりそう」で「分からない」でも「分かった」気になれるIT用語辞典 : セッションID](https://wa3.i-3-i.info/word15940.html)  

---
<a id="3"></a>

### セッション変数の利用方法

>セッションを開始すると、 PHP はまず、(通常はセッションクッキーから受け取る) ID を使って既存のセッションを取得しようとします。 ID を受け取らなかった場合は新しいセッションを作成します。 セッションを開始すると、PHP はスーパーグローバル $_SESSION にすべてのセッションデータを格納します。PHP スクリプトの処理が終了するときには、 スーパーグローバル $_SESSION の中身を自動的に受け取ってシリアライズし、 ストレージに送信します。  
[参考: PHPマニュアル : セッションの基本的な使用法](https://www.php.net/manual/ja/session.examples.basic.php#session.examples.basic)  
>

#### 格納
```php
$_SESSION['キー'] = 値;
```
#### 取得
```php
$_SESSION['キー'];
```
#### 破棄
```php
session_unset();
// または
session_destroy();
```

[参考: PHPマニュアル : セッション変数](https://www.php.net/manual/ja/reserved.variables.session.php)  
[参考: PHPマニュアル : セッション関数](https://www.php.net/manual/ja/ref.session.php)  

---
<a id="4"></a>

### フォーム入力値のセッション保存と再表示

入力された名前・メールアドレスなどをセッションに保存し、次のページで表示・確認できるようにする  

1. フォームの送信  
    ユーザーがフォームを送信する際に、入力された値をセッション変数に格納  
2. セッション変数の設定  
    PHPでは、`$_SESSIONスーパーグローバル変数` を使用してセッション変数を設定  
3. セッション変数の取得  
    別のページで、セッション変数 `$_SESSION['キー']` で保存されたデータを取得  
4. フォームへの再表示  
    取得したデータをフォームの初期値として設定することで、ユーザーは入力済みの状態から再開できる  

※セッションの有効期限  
セッションは、デフォルトでは一定時間で切れるように設定されている  
セッションの有効期限は、サーバーの設定ファイル（php.iniなど）で変更可能  
セッションの有効期限が切れると、保存されたデータは失われる  
必要に応じてセッションの有効期限を延長したり、永続的なストレージに保存したりするなどの対策が必要  

---

## セキュリティ面での注意

- セッションIDの `盗用対策` として、ログイン機能実装時には `session_regenerate_id()` を使用するのが一般的
- 出力前の `session_start();` の記述忘れに注意  
    → 必ずHTMLよりも前に記述する
- 入力値をセッションに入れる前でも、XSS対策として出力時には必ず `htmlspecialchars()` を使用する

---

### 練習問題 

以下の2ページ構成のフォームを作成し、セッションを使って入力値を受け渡す  

- form.php  
    フォーム画面（名前とメールアドレスを入力）
- confirm.php  
    確認画面（セッションから値を取り出して表示）  

---
## 作業チェックリスト

- `session_start();` を正しく使えたか
- フォームで送信した値を `$_SESSION` に保存できたか
- セッション変数から安全に値を取り出して表示できたか
- エスケープ処理を忘れずに行ったか

---
## 疑問・課題

- クッキーとの違い  
    → セッションはサーバーにデータを保存する、クッキーはブラウザ側にデータを保存する  
    ※ブラウザに保存されているデータはユーザー側で内容を書き換えることもできる → 個人情報などが見えるような場合ではセキュリティ面で優れるセッションを扱う  

    [参考: セッション（session）をPHPで使うための基本知識を解説！](https://techplay.jp/column/538)  
    [参考: 神田ITschool : セッションの仕組みを理解しよう](https://kanda-it-school-kensyu.com/php-basic-contents/pb_ch11/pb_1103/)  

- バリデーションを忘れる、記述場所迷う  
- `confirm.php` より、バリデーションとエスケープを同時に記述するか否か  
    ```php
    $name = htmlspecialchars($_SESSION['name'] = $_POST['name'], ENT_QUOTES, 'UTF-8');
    $email = htmlspecialchars($_SESSION['email'] = $_POST['email'], ENT_QUOTES, 'UTF-8');
    ```
    ワンライナーで記述でき、処理としては成立しているが…、  
    可読性や、保守性、デバックのしやすさを考慮すると分けて記述したほうが良い  
    → 開発現場では、チーム開発や将来的なメンテナンスを考慮して、`「1行で2つ以上のことをしない」` というスタイルが好まれる  

    → `「読みやすさと柔軟性」` を大事にするなら、分けるのがベター  

---

参考: []()
