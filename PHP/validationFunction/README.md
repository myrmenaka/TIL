# 2025.7.10 - 入力データの一括バリデーション関数

## 目的

複数の入力項目に対するバリデーション処理を `関数` にまとめて、一括で処理できるようにする方法を学ぶ  
→ 実用的なフォーム処理がより簡潔に書けるようになる

## 目次

- [バリデーション関数の必要性](#1)
- [一括バリデーション関数の考え方](#2)
- [実用的な関数の例（必須チェック）](#3)

## 学習内容

<a id="1"></a>

### バリデーション関数の必要性

- 入力項目が多くなると、同じようなチェックを何度も書く必要があるため、コードの可読性が低くなる  
- 同じ処理を関数にまとめておくことで、再利用生徒保守性が向上する  

※関数については、`Day6・Day7` でまとめている  

---
<a id="2"></a>

### 一括バリデーション関数の考え方

- 複数項目をループで処理する
- 入力値とバリデーションルールをセットで扱う

#### 一括バリデーションの拡張補足

- 多様なバリデーションルールへの対応

    - 必須チェックだけでなく、「形式チェック（メールアドレス・電話番号）」「数値範囲」「文字列長」などもルール化して関数に組み込める
    - 入力項目と同時に「チェック種別」や「条件」を配列に含めて渡せば、より柔軟な関数設計が可能  
    ```php
    $rules = [
        'name' => ['required'],
        'email' => ['required', 'email'],
        'age' => ['required', 'numeric', 'min' => 18]
    ];
    ```


- エラーの管理方法
    - エラーは項目ごとにまとめて連想配列にすると、表示処理がシンプルになる
    - エラーがない項目には何も追加せず、出力時には「isset()」などで条件分岐  
    ```php
    if (isset($errors['email'])) {
        echo $errors['email'];
    }
    ```

---
<a id="3"></a>

### 実用的な関数の例（必須チェック）

[required.php](./required.php)  

#### 関数の全体概要

この関数は、複数の必須入力項目がちゃんと入力されているかどうかをチェックして、入力漏れがある場合にはその項目ごとにエラーメッセージを返す処理

<関数の分解と説明>  
```php
function validate_required($inputs, $required_keys) {
```
- `function`  
    関数を定義するためのキーワード
- `validate_required`  
    関数名  
    意味は「必須項目のバリデーションを行う」
- `$inputs`  
    実際のユーザー入力（例: フォームの内容）
- `$required_keys`  
    必須チェックしたい項目名の一覧（例: `['name', 'email']`）

```php
$errors = [];
```
- エラーメッセージを入れていく `空の配列` を準備
- エラーが見つかるたびに `$errors` に追加されていく

```php
foreach ($required_keys as $key) {
```
- `foreach`  
    配列をループで1つずつ取り出す構文
- `$required_keys` に含まれる各項目名（name, email など）を `$key` へ代入しながら処理  

```php
if (!isset($inputs[$key]) || trim($inputs[$key]) === '') {
```
- `!isset(...)`  
    値が存在しない（定義されていない）かどうかをチェック
- `trim(...) === ''`  
    空白を除いて空文字かどうかをチェック  
    [参考: PHPマニュアル : trim()](https://www.php.net/manual/ja/function.trim.php)  
    [参考: 余分な空白・改行を取り除くtrim関数を使おう!〜PHP入門編〜](https://www.sejuku.net/blog/26644)
- つまり、「値がない or 空欄」の場合に、エラー判定  

```php
$errors[$key] = "{$key}は必須です。";
```
- エラーが見つかった項目名をキーとして、メッセージを配列に追加
- `"{$key}は必須です。"` は、PHPの変数展開で、例えば "nameは必須です。" になる  

```php
return $errors;
```
- 最後に `$errors` 配列を返す  
中身が空ならエラーなし、何か入っていればその項目に問題あり  

<使用例の解説>  
```php
$required = ['name', 'email', 'message'];
```
- 必須チェックしたい項目一覧を配列で定義  

```php
$errors = validate_required($_POST, $required);
```
- `$_POST` はフォーム送信されたデータの集合
- 定義した `$required` を使って関数を実行
- 結果として `$errors` にエラー情報が返される

---
---
## セキュリティ面での注意

- 入力値は関数内で使用する前に、`trim()` などで前後の空白を除去すると安全性か高まる    
- バリデーション後、出力する場合は `htmlspecialchars()` などでエスケープ処理を忘れずに
- JavaScriptによるクライアント側のバリデーションも併用すると、ユーザー体験も向上
- サーバー側はあくまで `最終防衛ライン` として位置づけるのが◎
- エラーメッセージには内部構造を含めないよう注意（例えばSQLのエラー詳細など）

## 練習問題 

名前・メールアドレス・年齢の3つの必須入力項目に対して、一括でバリデーションする関数を作成  

1. 必須項目を配列として用意する
2. 関数を定義し、ループで各項目の入力をチェック
3. エラーがあれば連想配列で返す
4. 関数を呼び出してエラーを表示

## 作業チェックリスト

- バリデーション処理を関数化できたか
- 配列で項目名を渡してループ処理できたか
- 実行結果で正しくエラーメッセージが表示されるか


## MEMO

- 初学者向けポイントまとめ  

    | 概念 | わかりやすく言うと… |   
    |:--:|:--:|  
    | `関数` | よく使う処理の「レシピ」や「道具箱」 |   
    | `配列` | データをまとめる「箱」 |   
    | `foreach` | 箱の中身を1つずつチェックするループ |   
    | `isset` | データがあるかどうか |   
    | `trim` | 空白を取り除く |   
    | `返り値` | 関数の「結果」 |   

- `validate.php` 解説  

    ※関数の定義部分の解説は[実用的な関数の例（必須チェック）](#3)に記述  

    // 実際にフォームから送信された値を受け取る  
    <バリデーション実行とエラーのチェック>  
    ```php
    $required = ['name', 'email', 'age'];
    ```
    - 入力が「必須」である項目をリストアップした配列
    - 今回は名前・メール・年齢が必須項目
    ```php
    $errors = validate_required($_POST, $required);
    ```
    - `$_POST` にはフォームから送られたデータが入っている
    - それを `validate_required()` 関数に渡して、入力チェック（バリデーション）を行う
    - チェックに引っかかった項目のエラーメッセージが `$errors` に格納される  

    // エラーがあれば表示  
    <エラーの有無で処理を分ける>  
    ```php
    if (!empty($errors)) {
    ```
    - `empty()` は「中身が空かどうか」を判定する関数
    - エラーがあればこの条件は `true` になって、エラー表示の処理に入る  

    <エラーがある場合の表示>  
    ```php
    foreach ($errors as $field => $error) {
        echo "<p>{$error}</p>";
    }
    ```
    - `$errors` に入っている各エラーメッセージを1つずつ取り出しながらループ
    - `<p>` タグで囲んでHTMLとして画面に表示
    - 例えば、メールが空欄なら「emailは必須項目です。」と表示される  

    <エラーがない（＝入力がすべてある）場合の表示>  
    ```php
    echo "<h3>✔ 入力が正常です！</h3>";
    ```
    - すべての必須項目が入力されている場合、成功メッセージを表示
    ```php
    echo "<p>名前: " . htmlspecialchars($_POST['name']) . "</p>";
    echo "<p>メール: " . htmlspecialchars($_POST['email']) . "</p>";
    echo "<p>年齢: " . htmlspecialchars($_POST['age']) . "</p>";
    ```
    - 入力された内容を表示
    - `htmlspecialchars()` を使ってエスケープ処理

---

参考: []()
