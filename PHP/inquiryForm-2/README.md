# 2025.7.15 - お問い合わせフォームの総合演習（メール送信機能を追加）

## 目的

`md_send_mail()関数` を使って、お問い合わせフォームから送信された内容を実際にメールで送れるようにする  
併せて、送信処理の注意点（文字化け・改行コード・XAMPPでの動作など）も理解する

## 目次

- [メール送信関数 `md_send_mail()` の基本](#1)
- [引数の意味と注意点](#2)
- [XAMPP環境での注意（Windows）](#3)

## 学習内容

<a id="1"></a>

### メール送信関数 `md_send_mail()` の基本

- 日本語に対応したメールを送るための関数（ `mail()` のマルチバイト対応版）  

     ※`mail()` と `md_send_mail()` 使い分けポイント    
    | 条件 | 適した関数 |   
    |:--:|:--:|  
    | メールが `日本語を含む` | `mb_send_mail()` |   
    | `英語のみ` で送信 | `mail()` でもOK |   
    | `本番環境` での確実な送信 | `mb_send_mail()` が安心 |   
    | `文字化け・エンコード制御` が必要 | `mb_send_mail()` |   
    | テストやシンプル送信 | `mail()`（ただし制限に注意） |   

    [参考: PHPマニュアル : md_send_mail()](https://www.php.net/manual/ja/function.mb-send-mail.php)  
    [参考: PHPマニュアル : mail()](https://www.php.net/manual/ja/function.mail.php)  

    ※マルチバイトとは  
    `全角文字` の別の呼び名  
    [参考: 「分かりそう」で「分からない」でも「分かった」気になれるIT用語辞典 : マルチバイトとは](https://wa3.i-3-i.info/word1809.html)  

- 使い方の基本  
```php
md_language("japanese");
md_internal_encoding("UTF-8");

md_send_mail($to, $subject, $body, $headers);
```
[参考: PHPマニュアル : md_language()](https://www.php.net/manual/ja/function.mb-language.php)  
[参考: PHPマニュアル : md_internal_encoding()](https://www.php.net/manual/ja/function.mb-internal-encoding.php)  

※エンコードとは  
文字などのデータをコンピュータが扱えるように変換すること  

→ よく `UTF-8` が選ばれる理由  
| 特徴 | メリット |   
|:--:|:--:|  
| Unicodeベース | 世界中の文字に対応 |   
| ASCII互換 | 古い環境でも使える |   
| 可変長 | データサイズを抑えられる |   
| Web標準 | HTMLやメールで安心 |   
| 安定性 | 文字化けしにくい |   

[参考: 「分かりそう」で「分からない」でも「分かった」気になれるIT用語辞典 : エンコードとは](https://wa3.i-3-i.info/word135.html)  

ちなみに…  
同じく `変換` に関わる技術に、`コンパイル` があるがこちらは、`java` や `C言語` などの `ソースコード` を機械語（コンピュータが実行できる形）に変換すること  
→ 目的と対象が異なる  
※PHPは基本「インタプリタ型」なので、コンパイルは不要

---
<a id="2"></a>

### 引数の意味と注意点
```php
md_send_mail($to, $subject, $body, $headers);
```

|引数|説明|  
|:--:|:--:|  
| `$to` | 宛先メールアドレス |  
| `$subject` | 件名（UTF-8 対応） |  
| `$body` | 本文 |  
| `$headers` | 追加ヘッダー（ `From` 等を指定） |  

- `From` を指定しないと、迷惑メール扱いになる可能性があるため注意  
    ※`From` : メールの差出人  
- 本番環境では `Return-Path` なども必要になるケースがある  
    ※`Return-Path（リターンパス）` とは、メールが送信エラーになった場合に、エラーメール（バウンスメール）を受け取るためのメールアドレスのこと  
    [参考: 「分かりそう」で「分からない」でも「分かった」気になれるIT用語辞典 : Return-Path](https://wa3.i-3-i.info/word11110.html)  

---
<a id="3"></a>

### XAMPP環境での注意（Windows）

- `md_send_mail()` は標準では使えない（設定とSMTPサーバーが必要）
- 今回は「コードを書く練習」として行い、実際の送信は本番環境でテストする

---
---
## セキュリティ面での注意

- `$_POST` の値をメールに出力する前に、`htmlspecialchars()` は不要（メール内なのでHTML出力ではない為）
- `メールヘッダーインジェクション対策` として、ユーザー入力値に 改行コード（ `\r` や `\n` ）が含まれていないかをチェックするとより安全  
    ※メールヘッダインジェクションとは、悪意のあるユーザーがメールのヘッダ情報に不正なデータを挿入する攻撃手法  
    [参考: ITを分かりやすく解説 : メールヘッダ・インジェクションとは | 分かりやすく図解で解説](https://medium-company.com/%E3%83%A1%E3%83%BC%E3%83%AB%E3%83%98%E3%83%83%E3%83%80%E3%83%BB%E3%82%A4%E3%83%B3%E3%82%B8%E3%82%A7%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3/)    
- 実際の送信前に、`入力内容の妥当性チェック（バリデーション）` を行うことが重要

## 練習問題 

前回（ `Day23` ）で作成したお問い合わせフォームに、ユーザー宛と管理者宛の2通のメールを送信する処理を追加  
※完了画面のメッセージも変更

## 作業チェックリスト

- `md_send_mail()` で2通のメールを送る処理を実装したか
- 本文・件名にマルチバイト文字を使ってもエラーが出ないか確認したか
- 宛先や From の指定が正しくできているか


## MEMO

- 存在しないメールアドレスへの送信はどうなるのか  

    → 破棄はされず、`mb_send_mail()` は送信された扱いになる  
    つまり、PHP側では「送ったよ！」って反応するけど、
    相手のアドレスが実在しない場合は サーバー側やメールサービス側でエラーになる可能性がある  

    <見えない裏側の流れ>  
    1．`mb_send_mail()` → メールサーバに「このメール送ってね」と渡す  
    2．メールサーバ → 指定の宛先に配送しようとする  
    3．宛先が存在しない（～@example.comに該当アドレスなし）  
    4．失敗して「バウンスメール（エラーメール）」として戻ってくることも  
    ※戻ってこないこともある（捨てられる・記録のみ）  

    <失敗したかわかるのか>  
    `mb_send_mail()` は `true` / `false` を返すだけで「届いたか」は保証しない  
    これはあくまで `「送信処理が成功したか（メールサーバに渡せたか）」という判定` であって、受信側で存在するか、受信されたかどうかはわからない  

    <プロがやってる対策例>  
    | 方法 | 説明 |   
    |:--:|:--:|  
    | ダミーアドレスではなく、実在するテスト用アドレスを使う | Gmailや独自ドメインのテストメールなど |   
    | バウンス用の受信アドレスを設定 | Return-Path: を指定して、失敗メールを受け取る用 |   
    | メールログを残す | サーバー上で sendmail ログや SMTP ログを追う |  
    | 外部のメールサービスを使う | SendGrid, Mailgun などでは送信失敗も検知できる◎ |   

- エスケープ処理について  

    <基本の考え方>  
    | 処理対象 | エスケープが必要？ | 理由 |   
    |:--:|:--:|:--:|  
    | HTMLに出力する内容 | 必須！ | XSS対策として htmlspecialchars() を使う |   
    | メール本文（プレーンテキスト） | 通常は不要 | メールはHTMLではないため、タグの心配がない |   
    | メール本文（HTMLメール） | 必要 | HTMLタグや特殊文字の誤認識を防ぐため |   

    <正しい使い分けポイント>  
    | 処理場所 | エスケープ方法 | 目的 |   
    |:--:|:--:|:--:|  
    | HTML画面表示用 | htmlspecialchars() | XSS・レイアウト崩れ防止 |   
    | メール本文（テキスト） | そのままでもOK | ユーザー入力を自然なままに伝える |   
    | メール本文（HTML） | エスケープ＋整形 | タグ処理と表示整形の両方に対応 |   
    
    - フォーム表示 → htmlspecialchars()  
    - htmlspecialchars() は `HTML用のエスケープ` だから、メールでは `<` → `&lt;` や `&` → `&amp;` のように変換されてしまって読みにくくなる  

    - メール本文 → htmlspecialchars() でエスケープせず、生のPOST値を使う（nl2brも使わない）  
    - `nl2br()` もHTML用 → メールではそのまま `\n` で改行した方が自然に表示される  

    <まとめ>  
    | 用途 | 推奨する値 |   
    |:--:|:--:|  
    | 画面表示（HTML） | `htmlspecialchars($_POST['...'])` で安全に |   
    | メール送信（テキスト） | `$_POST['...']` をそのまま使う（整形するなら `trim()` や `str_replace()` など）  

---

参考: []()
